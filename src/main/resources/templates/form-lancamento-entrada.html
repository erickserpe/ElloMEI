<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout :: layout-base(~{::title}, ~{::#conteudo-principal})}">
<head>
    <title>Nova Entrada</title>
</head>
<body>

<div id="conteudo-principal">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-5">
        <div>
            <h1 class="h2 fw-bold text-gray-900 mb-1" th:if="*{grupoOperacao == null}">
                <i class="bi bi-arrow-down-circle text-success me-2"></i>
                Nova Entrada
            </h1>
            <h1 class="h2 fw-bold text-gray-900 mb-1" th:unless="*{grupoOperacao == null}">
                <i class="bi bi-pencil-square text-success me-2"></i>
                Editar Entrada
            </h1>
            <p class="text-muted mb-0">Registre uma nova receita ou entrada de dinheiro</p>
        </div>
        <a th:href="@{/lancamentos}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-2"></i>
            <span class="d-none d-sm-inline">Voltar para Lista</span>
            <span class="d-sm-none">Voltar</span>
        </a>
    </div>

    <form th:action="@{/lancamentos}" method="post" th:object="${lancamentoForm}" enctype="multipart/form-data">
        <input type="hidden" th:field="*{grupoOperacao}" />
        <input type="hidden" th:field="*{tipo}" />

        <div class="form-section-card mb-4">
            <div class="form-section-header">
                <h5>
                    <i class="bi bi-info-circle text-primary"></i>
                    Dados Gerais
                </h5>
            </div>
            <div class="form-section-body">
                <div class="row g-4">
                    <div class="col-md-6">
                        <label for="descricao" class="form-label">
                            <i class="bi bi-card-text me-1"></i>
                            Descrição *
                        </label>
                        <input type="text" class="form-control" id="descricao" th:field="*{descricao}"
                               placeholder="Ex: Venda de produto, Prestação de serviço..." required>
                    </div>
                    <div class="col-md-3">
                        <label for="data" class="form-label">
                            <i class="bi bi-calendar3 me-1"></i>
                            Data *
                        </label>
                        <input type="date" class="form-control" id="data" th:field="*{data}" required>
                    </div>
                    <div class="col-md-3">
                        <label for="status" class="form-label">
                            <i class="bi bi-check-circle me-1"></i>
                            Status *
                        </label>
                        <select class="form-select" id="status" th:field="*{status}" required>
                            <option value="">Selecione o status</option>
                            <option th:each="statusOpt : ${T(br.com.scfmei.domain.StatusLancamento).getIncomeStatuses()}"
                                    th:value="${statusOpt}" th:text="${statusOpt.descricao}"></option>
                        </select>
                    </div>
                </div>
                <div class="row g-4">
                    <div class="col-md-6">
                        <label for="contato" class="form-label">
                            <i class="bi bi-person me-1"></i>
                            Pessoa/Cliente
                        </label>
                        <select class="form-select" id="contato" th:field="*{contato}">
                            <option value="">Selecione um cliente</option>
                            <option th:each="p : ${listaDePessoas}" th:value="${p.id}" th:text="${p.getNomeExibicao()}"></option>
                        </select>
                        <div class="form-text">Opcional - cliente ou pessoa que pagou</div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label d-block">
                            <i class="bi bi-receipt me-1"></i>
                            Documentação Fiscal
                        </label>
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" id="comNotaFiscal" th:field="*{comNotaFiscal}">
                            <label class="form-check-label fw-medium" for="comNotaFiscal">
                                Esta entrada possui Nota Fiscal
                            </label>
                        </div>
                        <div class="form-text">Marque se houver documento fiscal relacionado</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment Methods Section -->
        <div class="form-section-card mb-4">
            <div class="form-section-header">
                <h5>
                    <i class="bi bi-credit-card text-primary"></i>
                    Formas de Recebimento
                </h5>
            </div>
            <div class="form-section-body">
                <div id="pagamentos-container">
                    <div th:each="pagamento, iterStat : *{pagamentos}" class="row pagamento-item mb-4 p-3 bg-gray-50 rounded-lg align-items-end">
                        <div class="col-md-5">
                            <label class="form-label fw-medium">
                                <i class="bi bi-wallet2 me-1"></i>
                                Conta *
                            </label>
                            <select class="form-select" th:field="*{pagamentos[__${iterStat.index}__].conta}" required>
                                <option value="">Selecione uma conta</option>
                                <option th:each="c : ${listaDeContas}" th:value="${c.id}" th:text="${c.nomeConta}"></option>
                            </select>
                        </div>
                        <div class="col-md-5">
                            <label class="form-label fw-medium">
                                <i class="bi bi-currency-dollar me-1"></i>
                                Valor *
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input type="number" step="0.01" class="form-control valor-pagamento"
                                       th:field="*{pagamentos[__${iterStat.index}__].valor}"
                                       placeholder="0,00" required>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-outline-danger btn-sm w-100 remover-pagamento"
                                    th:if="${iterStat.index > 0}">
                                <i class="bi bi-trash"></i>
                                Remover
                            </button>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
                    <button type="button" id="adicionar-pagamento" class="btn btn-outline-primary">
                        <i class="bi bi-plus-circle me-2"></i>
                        Adicionar Forma de Recebimento
                    </button>
                    <div class="text-end">
                        <small class="text-muted d-block">Total Adicionado:</small>
                        <strong class="h5 text-success mb-0" id="total-adicionado">R$ 0,00</strong>
                    </div>
                </div>
            </div>
        </div>

        <!-- File Upload Section -->
        <div class="form-section-card mb-4">
            <div class="form-section-header">
                <h5>
                    <i class="bi bi-paperclip text-primary"></i>
                    Comprovante
                </h5>
            </div>
            <div class="form-section-body">
                <div class="row g-4">
                    <div class="col-12">
                        <label for="comprovanteFile" class="form-label">
                            <i class="bi bi-cloud-upload me-1"></i>
                            Anexar Comprovante
                        </label>
                        <input type="file" class="form-control" id="comprovanteFile" name="comprovanteFile"
                               accept="image/*,.pdf">
                        <div class="form-text">Opcional - Anexe uma imagem ou PDF do comprovante de recebimento</div>
                    </div>
                </div>

                <!-- Display existing attachments if editing -->
                <div th:if="*{comprovantes != null and !comprovantes.empty}" class="mt-4" id="comprovantes-container">
                    <h6 class="fw-medium mb-3">
                        <i class="bi bi-files me-1"></i>
                        Comprovantes Anexados
                    </h6>
                    <div class="row g-3">
                        <div th:each="comprovante : *{comprovantes}" class="col-md-4" th:id="'comprovante-card-' + ${comprovante.id}">
                            <div class="card border-0 bg-light">
                                <div class="card-body p-3 d-flex justify-content-between align-items-center">
                                    <a th:href="@{'/uploads/' + ${comprovante.pathArquivo}}" class="text-decoration-none text-dark small" target="_blank">
                                        <i class="bi bi-file-earmark-text me-2"></i>
                                        <span th:text="${#strings.substringAfter(comprovante.pathArquivo, '_')}">arquivo.pdf</span>
                                    </a>
                                    <button type="button" class="btn btn-sm btn-outline-danger" th:data-comprovante-id="${comprovante.id}" onclick="excluirComprovante(this)">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-5 d-flex justify-content-between align-items-center">
            <div class="text-muted small">
                <i class="bi bi-info-circle me-1"></i>
                Campos marcados com * são obrigatórios
            </div>
            <div class="d-flex gap-3">
                <a th:href="@{/lancamentos}" class="btn btn-outline-secondary">
                    <i class="bi bi-x-circle me-2"></i>
                    Cancelar
                </a>
                <button type="submit" class="btn btn-success px-4">
                    <i class="bi bi-check-circle me-2"></i>
                    <span th:if="*{grupoOperacao == null}">Registrar Entrada</span>
                    <span th:unless="*{grupoOperacao == null}">Salvar Alterações</span>
                </button>
            </div>
        </div>
    </form>

    <!-- Template for new payments -->
    <div id="pagamento-template" style="display: none;">
        <div class="row pagamento-item mb-4 p-3 bg-gray-50 rounded-lg align-items-end">
            <div class="col-md-5">
                <label class="form-label fw-medium">
                    <i class="bi bi-wallet2 me-1"></i>
                    Conta *
                </label>
                <select class="form-select" name="pagamentos[INDEX].conta" required>
                    <option value="">Selecione uma conta</option>
                    <option th:each="c : ${listaDeContas}" th:value="${c.id}" th:text="${c.nomeConta}"></option>
                </select>
            </div>
            <div class="col-md-5">
                <label class="form-label fw-medium">
                    <i class="bi bi-currency-dollar me-1"></i>
                    Valor *
                </label>
                <div class="input-group">
                    <span class="input-group-text">R$</span>
                    <input type="number" step="0.01" class="form-control valor-pagamento"
                           name="pagamentos[INDEX].valor" placeholder="0,00" required>
                </div>
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-outline-danger btn-sm w-100 remover-pagamento">
                    <i class="bi bi-trash"></i>
                    Remover
                </button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let pagamentoIndex = /*[[${#lists.size(lancamentoForm.pagamentos)}]]*/ 1;

            // Function to calculate total
            function calcularTotal() {
                let total = 0;
                document.querySelectorAll('.valor-pagamento').forEach(input => {
                    const valor = parseFloat(input.value) || 0;
                    total += valor;
                });
                document.getElementById('total-adicionado').textContent =
                    new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(total);
            }

            // Add payment method
            document.getElementById('adicionar-pagamento').addEventListener('click', function() {
                const template = document.getElementById('pagamento-template').innerHTML;
                const newPayment = template.replace(/INDEX/g, pagamentoIndex);
                document.getElementById('pagamentos-container').insertAdjacentHTML('beforeend', newPayment);
                pagamentoIndex++;
                calcularTotal();
            });

            // Remove payment method
            document.addEventListener('click', function(e) {
                if (e.target.closest('.remover-pagamento')) {
                    e.target.closest('.pagamento-item').remove();
                    calcularTotal();
                }
            });

            // Calculate total on value change
            document.addEventListener('input', function(e) {
                if (e.target.classList.contains('valor-pagamento')) {
                    calcularTotal();
                }
            });

            // Initial calculation
            calcularTotal();
        });

        function excluirComprovante(button) {
            const comprovanteId = button.getAttribute('data-comprovante-id');
            if (!confirm('Tem certeza que deseja excluir este comprovante?')) {
                return;
            }

            fetch(`/lancamentos/comprovante/${comprovanteId}`, {
                method: 'DELETE',
                headers: {
                    // Spring Security requires a CSRF token for DELETE requests
                    'X-XSRF-TOKEN': getCsrfToken()
                }
            })
            .then(response => {
                if (response.ok) {
                    // Remove the attachment card from the UI
                    const card = document.getElementById(`comprovante-card-${comprovanteId}`);
                    if (card) {
                        card.remove();
                    }
                } else {
                    alert('Erro ao excluir o comprovante.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Ocorreu um erro na requisição.');
            });
        }

        // Helper function to get CSRF token from cookies (if enabled)
        function getCsrfToken() {
            const token = document.cookie.split('; ')
                                  .find(row => row.startsWith('XSRF-TOKEN='))
                                  ?.split('=')[1];
            return token || ''; // Return empty if not found
        }
    </script>
</div>

</body>
</html>
