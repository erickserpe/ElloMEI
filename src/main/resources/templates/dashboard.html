<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout :: layout-base(~{::title}, ~{::div})}">
<head>
    <title>Dashboard - SCF MEI</title>
</head>
<body>
<div>
    <h1 class="mb-4">Painel de Controle</h1>

    <div class="card mb-4">
        <div class="card-header">
            Filtros
        </div>
        <div class="card-body">
            <form th:action="@{/}" method="get" id="global-filter-form" class="row g-3 align-items-center">
                <div class="col-md-3">
                    <label for="dataInicio" class="form-label">Data de Início</label>
                    <input type="date" id="dataInicio" name="dataInicio" class="form-control" th:value="${dataInicioSel != null ? #temporals.format(dataInicioSel, 'yyyy-MM-dd') : ''}">
                </div>
                <div class="col-md-3">
                    <label for="dataFim" class="form-label">Data Fim</label>
                    <input type="date" id="dataFim" name="dataFim" class="form-control" th:value="${dataFimSel != null ? #temporals.format(dataFimSel, 'yyyy-MM-dd') : ''}">
                </div>
                <div class="col-md-2">
                    <label for="contaId" class="form-label">Conta</label>
                    <select id="contaId" name="contaId" class="form-select">
                        <option value="">Todas</option>
                        <option th:each="conta : ${listaDeContas}"
                                th:value="${conta.id}"
                                th:text="${conta.nomeConta}"
                                th:selected="${conta.id == contaIdSel}"></option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="pessoaId" class="form-label">Pessoa</label>
                    <select id="pessoaId" name="pessoaId" class="form-select">
                        <option value="">Todas</option>
                        <option th:each="pessoa : ${listaDePessoas}"
                                th:value="${pessoa.id}"
                                th:text="${pessoa.nome}"
                                th:selected="${pessoa.id == pessoaIdSel}"></option>
                    </select>
                </div>
                <div class="col-auto d-flex align-items-end">
                    <button type="submit" class="btn btn-primary me-2">Aplicar</button>
                    <a th:href="@{/}" class="btn btn-outline-secondary">Limpar</a>
                </div>
            </form>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div class="card text-white bg-success mb-3">
                <div class="card-header">SALDO TOTAL</div>
                <div class="card-body">
                    <h5 class="card-title" th:text="${'R$ ' + #numbers.formatDecimal(saldoTotal, 1, 'POINT', 2, 'COMMA')}">R$ 0,00</h5>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-info mb-3">
                <div class="card-header">ENTRADAS NO PERÍODO</div>
                <div class="card-body">
                    <h5 class="card-title" th:text="${'R$ ' + #numbers.formatDecimal(totalEntradas, 1, 'POINT', 2, 'COMMA')}">R$ 0,00</h5>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-dark bg-warning mb-3">
                <div class="card-header">SAÍDAS NO PERÍODO</div>
                <div class="card-body">
                    <h5 class="card-title" th:text="${'R$ ' + #numbers.formatDecimal(totalSaidas, 1, 'POINT', 2, 'COMMA')}">R$ 0,00</h5>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-2">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Controle de Faturamento MEI (Ano: <span th:text="${#dates.year(#dates.createNow())}">2025</span>)</span>
                    <div class="d-flex align-items-center">
                        <select id="faturamento-filter" class="form-select form-select-sm me-2" style="width: auto;">
                            <option value="OFICIAL" selected>Visão: Faturamento Oficial (MEI)</option>
                            <option value="BANCARIO">Visão: Faturamento Bancário</option>
                            <option value="ESTIMADO_CUSTOS">Visão: Meta (Baseado em Compras)</option>
                        </select>
                        <button type="button" id="gerar-relatorio-btn" class="btn btn-success btn-sm">Gerar PDF</button>
                    </div>
                </div>
                <div class="card-body">
                    <div>
                        <div class="d-flex justify-content-between">
                            <strong>Faturamento Anual</strong>
                            <div>
                                <span id="faturamento-anual-valor">R$ 0,00</span> /
                                <span>R$ 81.000,00</span>
                            </div>
                        </div>
                        <div class="progress" style="height: 20px;">
                            <div id="faturamento-anual-barra" class="progress-bar bg-info" role="progressbar" style="width: 0%;">0%</div>
                        </div>
                    </div>
                    <hr>
                    <div>
                        <div class="d-flex justify-content-between">
                            <strong>Faturamento Mensal (Proporcional)</strong>
                            <div>
                                <span id="faturamento-mensal-valor">R$ 0,00</span> /
                                <span>R$ 6.750,00</span>
                            </div>
                        </div>
                        <div class="progress" style="height: 20px;">
                            <div id="faturamento-mensal-barra" class="progress-bar bg-success" role="progressbar" style="width: 0%;">0%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Despesas por Categoria (Período)</h5>
                    <canvas id="despesasPorCategoriaChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script th:src="@{/webjars/chartjs/4.4.3/dist/chart.umd.js}"></script>
    <script th:inline="javascript">
        // Script para o Gráfico de Pizza
        document.addEventListener('DOMContentLoaded', function() {
            const dataInicio = /*[[${dataInicioSel}]]*/ null;
            const dataFim = /*[[${dataFimSel}]]*/ null;
            const contaId = /*[[${contaIdSel}]]*/ null;
            const pessoaId = /*[[${pessoaIdSel}]]*/ null;

            let apiUrl = '/api/dashboard/despesas-por-categoria?';
            if (dataInicio) apiUrl += `dataInicio=${dataInicio}&`;
            if (dataFim) apiUrl += `dataFim=${dataFim}&`;
            if (contaId) apiUrl += `contaId=${contaId}&`;
            if (pessoaId) apiUrl += `pessoaId=${pessoaId}&`;

            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    if (data.length === 0) return;
                    const labels = data.map(item => item.label);
                    const values = data.map(item => item.value);
                    const ctx = document.getElementById('despesasPorCategoriaChart');
                    new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Total Gasto',
                                data: values,
                                backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40']
                            }]
                        }
                    });
                });
        });

        // Script para o Widget de Faturamento Dinâmico
        function formatarMoeda(valor) {
            if(valor === null) return 'R$ 0,00';
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valor);
        }

        function atualizarWidgetFaturamento(tipoCalculo) {
            const apiUrl = `/api/dashboard/faturamento-widget?tipoCalculo=${tipoCalculo}`;
            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    const valorAnualEl = document.getElementById('faturamento-anual-valor');
                    const barraAnualEl = document.getElementById('faturamento-anual-barra');
                    const valorMensalEl = document.getElementById('faturamento-mensal-valor');
                    const barraMensalEl = document.getElementById('faturamento-mensal-barra');
                    const divMensal = document.getElementById('faturamento-mensal-div');
                    const hrSeparator = document.getElementById('faturamento-hr-separator');

                    const faturamentoAnual = data.faturamentoAnual || 0;
                    const percentualAnual = (faturamentoAnual / 81000 * 100).toFixed(1);
                    valorAnualEl.innerText = formatarMoeda(faturamentoAnual);
                    barraAnualEl.style.width = `${percentualAnual}%`;
                    barraAnualEl.innerText = `${percentualAnual}%`;

                    if (tipoCalculo === 'OFICIAL' || tipoCalculo === 'BANCARIO') {
                        divMensal.style.display = 'block';
                        hrSeparator.style.display = 'block';
                        const faturamentoMensal = data.faturamentoMensal || 0;
                        const percentualMensal = (faturamentoMensal / 6750 * 100).toFixed(1);
                        valorMensalEl.innerText = formatarMoeda(faturamentoMensal);
                        barraMensalEl.style.width = `${percentualMensal}%`;
                        barraMensalEl.innerText = `${percentualMensal}%`;
                    } else {
                        divMensal.style.display = 'none';
                        hrSeparator.style.display = 'none';
                    }
                });
        }

        const filtroFaturamentoEl = document.getElementById('faturamento-filter');
        filtroFaturamentoEl.addEventListener('change', (event) => {
            atualizarWidgetFaturamento(event.target.value);
        });

        document.addEventListener('DOMContentLoaded', () => {
            atualizarWidgetFaturamento('OFICIAL');
        });

        // Script para o botão de PDF
        document.addEventListener('DOMContentLoaded', function() {
            const pdfButton = document.getElementById('gerar-relatorio-btn');
            pdfButton.addEventListener('click', function() {
                const dataInicio = document.getElementById('dataInicio').value;
                const dataFim = document.getElementById('dataFim').value;
                const tipoVisao = document.getElementById('faturamento-filter').value;
                let reportUrl = `/relatorios/faturamento/dinamico/pdf?tipoVisao=${tipoVisao}`;
                if (dataInicio) reportUrl += `&dataInicio=${dataInicio}`;
                if (dataFim) reportUrl += `&dataFim=${dataFim}`;
                window.open(reportUrl, '_blank');
            });
        });
    </script>
</div>
</body>
</html>