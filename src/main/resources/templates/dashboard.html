<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout :: layout-base(~{::title}, ~{::#dashboard-content})}">
<head>
    <title>Dashboard - Ello MEI</title>
</head>
<body>
<div id="dashboard-content">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2">Dashboard</h1>
        <a th:href="@{/lancamentos/novo}" class="btn btn-primary shadow-sm">
            <i class="bi bi-plus-circle me-1"></i> Novo Lançamento
        </a>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-lg-4 col-md-6">
            <div class="card kpi-card-gradient bg-gradient-1 shadow-sm">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="kpi-title">Saldo Total</h5>
                        <p class="kpi-value" th:text="${#numbers.formatCurrency(saldoTotal)}">R$ 0,00</p>
                    </div>
                    <i class="bi bi-wallet2 kpi-icon"></i>
                </div>
            </div>
        </div>
        <div class="col-lg-4 col-md-6">
            <div class="card kpi-card-gradient bg-gradient-2 shadow-sm">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="kpi-title">Entradas no Período</h5>
                        <p class="kpi-value" th:text="${#numbers.formatCurrency(totalEntradas)}">R$ 0,00</p>
                    </div>
                    <i class="bi bi-arrow-down-circle kpi-icon"></i>
                </div>
            </div>
        </div>
        <div class="col-lg-4 col-md-12">
            <div class="card kpi-card-gradient bg-gradient-3 shadow-sm">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="kpi-title">Saídas no Período</h5>
                        <p class="kpi-value" th:text="${#numbers.formatCurrency(totalSaidas)}">R$ 0,00</p>
                    </div>
                    <i class="bi bi-arrow-up-circle kpi-icon"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="accordion mb-4" id="accordionFiltros">
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingFiltros">
                <button class="accordion-button collapsed bg-white" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFiltros" aria-expanded="false" aria-controls="collapseFiltros">
                    <i class="bi bi-filter me-2"></i> Filtros Avançados e Relatórios
                </button>
            </h2>
            <div id="collapseFiltros" class="accordion-collapse collapse" aria-labelledby="headingFiltros" data-bs-parent="#accordionFiltros">
                <div class="accordion-body">
                    <form th:action="@{/}" method="get" id="global-filter-form">
                        <div class="row g-3">
                            <div class="col-md-3"><label for="dataInicio" class="form-label">Data de Início</label><input type="date" id="dataInicio" name="dataInicio" class="form-control form-control-sm" th:value="${dataInicioSel != null ? #temporals.format(dataInicioSel, 'yyyy-MM-dd') : ''}"></div>
                            <div class="col-md-3"><label for="dataFim" class="form-label">Data Fim</label><input type="date" id="dataFim" name="dataFim" class="form-control form-control-sm" th:value="${dataFimSel != null ? #temporals.format(dataFimSel, 'yyyy-MM-dd') : ''}"></div>
                            <div class="col-md-6"><label for="descricao" class="form-label">Buscar na Descrição</label><input type="text" id="descricao" name="descricao" class="form-control form-control-sm" placeholder="Ex: Gasolina, Compra de material..." th:value="${descricaoSel}"></div>
                            <div class="col-md-3"><label for="contaId" class="form-label">Conta</label><select id="contaId" name="contaId" class="form-select form-select-sm"><option value="">Todas</option><option th:each="conta : ${listaDeContas}" th:value="${conta.id}" th:text="${conta.nomeConta}" th:selected="${conta.id == contaIdSel}"></option></select></div>
                            <div class="col-md-3"><label for="contatoId" class="form-label">Pessoa/Empresa</label><select id="contatoId" name="contatoId" class="form-select form-select-sm"><option value="">Todos</option><option th:each="contato : ${listaDePessoas}" th:value="${contato.id}" th:text="${contato.getNomeExibicao()}" th:selected="${contato.id == contatoIdSel}"></option></select></div>
                            <div class="col-md-3"><label for="categoriaId" class="form-label">Categoria de Despesa</label><select id="categoriaId" name="categoriaId" class="form-select form-select-sm"><option value="">Todas</option><option th:each="cat : ${listaDeCategorias}" th:value="${cat.id}" th:text="${cat.nome}" th:selected="${cat.id == categoriaIdSel}"></option></select></div>
                            <div class="col-md-3"><label for="status" class="form-label">Status do Lançamento</label><select id="status" name="status" class="form-select form-select-sm"><option value="">Todos</option><option th:each="s : ${T(br.com.scfmei.domain.StatusLancamento).values()}" th:value="${s}" th:text="${s.descricao}" th:selected="${s == statusSel}"></option></select></div>
                        </div>
                        <hr class="my-3">
                        <div class="d-flex justify-content-end align-items-center"><a th:href="@{/}" class="btn btn-outline-secondary me-2">Limpar</a><button type="submit" class="btn btn-primary"><i class="bi bi-funnel-fill me-2"></i>Aplicar</button></div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-7">
            <div class="card h-100">
                <div class="card-header bg-transparent pt-3 border-0"><h5 class="mb-0">Fluxo de Caixa (Últimos 12 Meses)</h5></div>
                <div class="card-body d-flex align-items-center justify-content-center" style="min-height: 350px;"><canvas id="fluxoDeCaixaChart"></canvas></div>
            </div>
        </div>
        <div class="col-lg-5">
            <div class="d-flex flex-column gap-4">
                <div class="card"><div class="card-header bg-transparent pt-3 border-0"><h5 class="mb-0">Despesas por Categoria</h5></div><div class="card-body d-flex align-items-center justify-content-center" style="min-height: 250px;"><canvas id="despesasPorCategoriaChart"></canvas></div></div>
                <div class="card"><div class="card-header d-flex justify-content-between align-items-center"><span>Controle de Faturamento MEI</span><select id="faturamento-filter" class="form-select form-select-sm" style="width: auto;"><option value="OFICIAL" selected>Oficial</option><option value="BANCARIO">Bancário</option><option value="ESTIMADO_CUSTOS">Por Compras</option></select></div><div class="card-body"><div class="mb-3"><div class="d-flex justify-content-between"><strong>Faturamento Anual</strong><div><span id="faturamento-anual-valor">R$ 0,00</span> / <span>R$ 81.000,00</span></div></div><div class="progress" style="height: 20px;"><div id="faturamento-anual-barra" class="progress-bar" role="progressbar" style="width: 0%;">0%</div></div></div><div><div class="d-flex justify-content-between"><strong id="faturamento-mensal-titulo">Faturamento Mensal</strong><div><span id="faturamento-mensal-valor">R$ 0,00</span> / <span id="faturamento-mensal-teto">R$ 6.750,00</span></div></div><div class="progress" style="height: 20px;"><div id="faturamento-mensal-barra" class="progress-bar bg-success" role="progressbar" style="width: 0%;">0%</div></div></div></div></div>
            </div>
        </div>
    </div>

    <script th:src="@{/webjars/chartjs/4.4.3/dist/chart.umd.js}"></script>
    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function() {

            function carregarGraficoPizza() {
                const dataInicio = /*[[${dataInicioSel}]]*/ null;
                const dataFim = /*[[${dataFimSel}]]*/ null;
                const contaId = /*[[${contaIdSel}]]*/ null;
                const contatoId = /*[[${contatoIdSel}]]*/ null;
                let apiUrl = '/api/dashboard/despesas-por-categoria?';
                if (dataInicio) apiUrl += `dataInicio=${dataInicio}&`;
                if (dataFim) apiUrl += `dataFim=${dataFim}&`;
                if (contaId) apiUrl += `contaId=${contaId}&`;
                if (contatoId) apiUrl += `contatoId=${contatoId}&`;

                fetch(apiUrl)
                    .then(response => response.json())
                    .then(data => {
                        const ctx = document.getElementById('despesasPorCategoriaChart');
                        if (window.graficoPizza) { window.graficoPizza.destroy(); }
                        if (!data || data.length === 0) {
                            return;
                        }
                        window.graficoPizza = new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                                labels: data.map(item => item.label),
                                datasets: [{
                                    data: data.map(item => item.value),
                                    backgroundColor: ['#0073e6', '#198754', '#ffc107', '#dc3545', '#6c757d', '#0dcaf0']
                                }]
                            },
                            options: { responsive: true, maintainAspectRatio: false }
                        });
                    });
            }

            function carregarGraficoFluxoDeCaixa() {
                fetch('/api/dashboard/fluxo-caixa-mensal')
                    .then(response => response.json())
                    .then(data => {
                        const ctx = document.getElementById('fluxoDeCaixaChart');
                        new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: data.labels,
                                datasets: [
                                    {
                                        label: 'Entradas',
                                        data: data.entradas,
                                        backgroundColor: 'rgba(25, 135, 84, 0.7)'
                                    },
                                    {
                                        label: 'Saídas',
                                        data: data.saidas,
                                        backgroundColor: 'rgba(220, 53, 69, 0.7)'
                                    }
                                ]
                            },
                            options: {
                                scales: { y: { beginAtZero: true } },
                                responsive: true,
                                maintainAspectRatio: false
                            }
                        });
                    });
            }

            function formatarMoeda(valor) {
                if(valor === null || valor === undefined) return 'R$ 0,00';
                return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valor);
            }

            function atualizarWidgetFaturamento(tipoCalculo) {
                fetch(`/api/dashboard/faturamento-widget?tipoCalculo=${tipoCalculo}`)
                    .then(response => response.json())
                    .then(data => {
                        const valorAnualEl = document.getElementById('faturamento-anual-valor');
                        const barraAnualEl = document.getElementById('faturamento-anual-barra');
                        const valorMensalEl = document.getElementById('faturamento-mensal-valor');
                        const barraMensalEl = document.getElementById('faturamento-mensal-barra');
                        const tituloMensalEl = document.getElementById('faturamento-mensal-titulo');
                        const tetoMensalEl = document.getElementById('faturamento-mensal-teto');
                        const faturamentoAnual = data.faturamentoAnual || 0;
                        const percentualAnual = (faturamentoAnual / 81000 * 100).toFixed(1);
                        valorAnualEl.innerText = formatarMoeda(faturamentoAnual);
                        barraAnualEl.style.width = `${percentualAnual}%`;
                        barraAnualEl.innerText = `${percentualAnual}%`;
                        const faturamentoMensal = data.faturamentoMensal || 0;
                        const percentualMensal = (faturamentoMensal / 6750 * 100).toFixed(1);
                        valorMensalEl.innerText = formatarMoeda(faturamentoMensal);
                        barraMensalEl.style.width = `${percentualMensal}%`;
                        barraMensalEl.innerText = `${percentualMensal}%`;
                        tetoMensalEl.style.display = 'inline';
                        if (tipoCalculo === 'ESTIMADO_CUSTOS') {
                            tituloMensalEl.innerText = 'Meta Mensal';
                            tetoMensalEl.style.display = 'none';
                        } else {
                            tituloMensalEl.innerText = 'Faturamento Mensal';
                            tetoMensalEl.innerText = '/ R$ 6.750,00';
                        }
                    });
            }

            function configurarBotaoPdfAnalise() {
                const pdfButton = document.getElementById('gerar-relatorio-btn');
                if(pdfButton) {
                    pdfButton.addEventListener('click', function() {
                        const form = document.getElementById('global-filter-form');
                        const formData = new FormData(form);
                        const params = new URLSearchParams(formData);
                        params.append('tipoVisao', 'ANALISE_GERAL');
                        const reportUrl = `/relatorios/faturamento/dinamico/pdf?${params.toString()}`;
                        window.open(reportUrl, '_blank');
                    });
                }
            }

            function configurarBotaoPdfFaturamentoMEI() {
                const meiPdfButton = document.getElementById('gerar-relatorio-mei-btn');
                if(meiPdfButton) {
                    meiPdfButton.addEventListener('click', function() {
                        const tipoVisao = document.getElementById('faturamento-filter').value;
                        const dataInicio = document.getElementById('dataInicio').value;
                        const dataFim = document.getElementById('dataFim').value;
                        let reportUrl = `/relatorios/faturamento/dinamico/pdf?tipoVisao=${tipoVisao}`;
                        if (dataInicio) reportUrl += `&dataInicio=${dataInicio}`;
                        if (dataFim) reportUrl += `&dataFim=${dataFim}`;
                        window.open(reportUrl, '_blank');
                    });
                }
            }

            const filtroFaturamentoEl = document.getElementById('faturamento-filter');
            if(filtroFaturamentoEl) {
                filtroFaturamentoEl.addEventListener('change', (event) => {
                    atualizarWidgetFaturamento(event.target.value);
                });
            }

            carregarGraficoPizza();
            carregarGraficoFluxoDeCaixa();
            atualizarWidgetFaturamento('OFICIAL');
            configurarBotaoPdfAnalise();
            configurarBotaoPdfFaturamentoMEI();
        });
    </script>
</div>
</body>
</html>